<!-- Onboarding Flow -->
<div *ngIf="showOnboarding" class="onboarding-overlay">
  <div class="onboarding-modal">
    <!-- Step 1: Welcome -->
    <div *ngIf="onboardingStep === 1" class="onboarding-step">
      <div class="onboarding-icon">
        <div class="icon-gradient">
          <span class="sparkle">✨</span>
        </div>
      </div>
      <h1 class="onboarding-title">Welcome to SmartSpend! 🎉</h1>
      <p class="onboarding-description">
        Your intelligent financial companion that helps you track, analyze, and optimize your spending.
      </p>
      <div class="onboarding-progress">
        <div class="progress-dots">
          <div class="dot active"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>
      <button class="onboarding-btn primary" (click)="nextOnboardingStep()">
        Next
      </button>
    </div>

    <!-- Step 2: Connect Accounts -->
    <div *ngIf="onboardingStep === 2" class="onboarding-step">
      <div class="onboarding-icon">
        <div class="icon-gradient">
          <span class="bank-icon">🏦</span>
        </div>
      </div>
      <h1 class="onboarding-title">Connect Your Accounts</h1>
      <p class="onboarding-description">
        Securely link your bank accounts and credit cards to automatically track your transactions.
      </p>
      <div class="onboarding-progress">
        <div class="progress-dots">
          <div class="dot completed"></div>
          <div class="dot active"></div>
          <div class="dot"></div>
        </div>
      </div>
      <div class="onboarding-actions">
        <button class="onboarding-btn secondary" (click)="previousOnboardingStep()">
          Back
        </button>
        <button class="onboarding-btn primary" (click)="nextOnboardingStep()">
          Next
        </button>
      </div>
    </div>

    <!-- Step 3: Get Started -->
    <div *ngIf="onboardingStep === 3" class="onboarding-step">
      <div class="onboarding-icon">
        <div class="icon-gradient">
          <span class="chart-icon">📊</span>
        </div>
      </div>
      <h1 class="onboarding-title">Get Started</h1>
      <p class="onboarding-description">
        Start tracking your spending and get AI-powered insights to improve your financial health.
      </p>
      <div class="onboarding-progress">
        <div class="progress-dots">
          <div class="dot completed"></div>
          <div class="dot completed"></div>
          <div class="dot active"></div>
        </div>
      </div>
      <div class="onboarding-actions">
        <button class="onboarding-btn secondary" (click)="previousOnboardingStep()">
          Back
        </button>
        <button class="onboarding-btn primary" (click)="completeOnboarding()">
          Get Started
        </button>
      </div>
    </div>

    <!-- Skip option -->
    <button class="skip-onboarding" (click)="skipOnboarding()">
      Skip for now
    </button>
  </div>
</div>

<!-- Connection Popup -->
<div *ngIf="showConnectionPopup" class="connection-popup-overlay">
  <div class="connection-popup">
    <div class="popup-header">
      <div class="popup-icon">
        <div class="icon-gradient">
          <span class="bank-icon">🏦</span>
        </div>
      </div>
      <h2 class="popup-title">Connect Your Bank Account</h2>
      <p class="popup-description">
        Securely link your bank accounts to start tracking your spending and get personalized insights.
      </p>
    </div>
    
    <div class="popup-content">
      <div class="connection-benefits">
        <div class="benefit-item">
          <span class="benefit-icon">🔒</span>
          <div class="benefit-text">
            <h4>Secure & Private</h4>
            <p>Bank-level security with read-only access</p>
          </div>
        </div>
        <div class="benefit-item">
          <span class="benefit-icon">📊</span>
          <div class="benefit-text">
            <h4>Smart Insights</h4>
            <p>AI-powered spending analysis and recommendations</p>
          </div>
        </div>
        <div class="benefit-item">
          <span class="benefit-icon">⚡</span>
          <div class="benefit-text">
            <h4>Real-time Updates</h4>
            <p>Automatic transaction syncing and categorization</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="popup-actions">
      <button class="popup-btn secondary" (click)="closeConnectionPopup()">
        Skip for now
      </button>
      <button class="popup-btn primary" (click)="connectAccountFromPopup()">
        <span class="btn-icon">🔗</span>
        Connect Account
      </button>
    </div>
    
    <button class="popup-close" (click)="closeConnectionPopup()">
      ✕
    </button>
  </div>
</div>

<!-- Main Dashboard (only show after onboarding and connection popup) -->
<div *ngIf="!showOnboarding && !showConnectionPopup" class="layout">
  <header class="topbar">
    <div class="brand">{{ title }}</div>
    <div class="header-actions">
      <button class="add-btn" (click)="connectBank()" title="Connect Bank Account">
        <span class="plus-icon">+</span>
        <span class="add-text">Add Account</span>
      </button>
      <span *ngIf="isLinked" class="status-badge">🟢 Connected</span>
      <!-- Development: Reset onboarding button -->
      <button class="reset-btn" (click)="resetOnboarding()" title="Reset Onboarding">
        🔄 Reset
      </button>
    </div>
  </header>

  <main class="content">
    <!-- Quick Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card balance">
        <div class="stat-icon">💰</div>
        <div class="stat-content">
          <div class="stat-label">Total Balance</div>
          <div class="stat-value">{{ getTotalBalance() | currency }}</div>
          <div class="stat-change positive">+70.4% from last month</div>
        </div>
      </div>
      
      <div class="stat-card income">
        <div class="stat-icon">📈</div>
        <div class="stat-content">
          <div class="stat-label">Total Income</div>
          <div class="stat-value">$5,000</div>
          <div class="stat-change positive">+2.5% from last month</div>
        </div>
      </div>
      
      <div class="stat-card expenses">
        <div class="stat-icon">📉</div>
        <div class="stat-content">
          <div class="stat-label">Total Expenses</div>
          <div class="stat-value">{{ (insights?.totalThisMonth || 0) | currency }}</div>
          <div class="stat-change negative">-1.2% from last month</div>
        </div>
      </div>
    </div>

    <div class="dashboard-grid">
      <section class="card chart-card">
        <h2>Spending Breakdown</h2>
        <div class="chart"><canvas id="pieChart"></canvas></div>
      </section>

      <section class="card insights-card">
        <h2>Top Categories</h2>
        <div *ngIf="insights?.topCategories?.length; else noInsights" class="categories-list">
          <div *ngFor="let c of insights?.topCategories; let i = index" class="category-item">
            <div class="category-dot" [style.background-color]="getCategoryColor(i)"></div>
            <div class="category-info">
              <span class="category-name">{{ formatCategoryName(c.name) }}</span>
              <span class="category-amount">{{ c.total | currency }}</span>
            </div>
          </div>
        </div>
        <ng-template #noInsights>
          <div class="empty-state">
            <span class="empty-icon">📊</span>
            <p>Connect an account to see spending insights</p>
          </div>
        </ng-template>
      </section>
    </div>

    <!-- Accounts Section -->
    <section class="card accounts-section">
      <div class="section-header">
        <h2>Connected Accounts</h2>
        <span class="account-count" *ngIf="accounts?.length">{{ accounts.length }} account{{ accounts.length === 1 ? '' : 's' }}</span>
      </div>
      <div *ngIf="accounts?.length; else noAccounts" class="accounts-grid">
        <div *ngFor="let a of accounts" class="account-card">
          <div class="account-info">
            <div class="account-icon">🏦</div>
            <div class="account-details">
              <h3 class="account-name">{{ a.name }}</h3>
              <p class="account-type">{{ getAccountType(a.type) }}</p>
            </div>
          </div>
          <div class="account-balance">
            <span class="balance-amount">{{ a.balances?.current | currency }}</span>
            <span class="balance-label">Available</span>
          </div>
        </div>
      </div>
      <ng-template #noAccounts>
        <div class="empty-state">
          <span class="empty-icon">🏦</span>
          <p>No accounts connected yet</p>
          <button class="add-btn-small" (click)="connectBank()">+ Connect Account</button>
        </div>
      </ng-template>
    </section>

    <!-- Transactions Section -->
    <section class="card transactions-section">
      <div class="section-header">
        <div class="header-left">
          <h2>Recent Transactions</h2>
          <span class="transaction-count" *ngIf="transactions?.length">{{ transactions.length }} transaction{{ transactions.length === 1 ? '' : 's' }}</span>
        </div>
        <button class="refresh-btn" (click)="refreshData()" title="Refresh Data">
          <span class="refresh-icon">🔄</span>
        </button>
      </div>
      <div *ngIf="isLoadingTransactions" class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading transactions...</p>
      </div>
      <div *ngIf="!isLoadingTransactions && transactions.length > 0" class="transactions-container">
        <div class="transactions">
          <div *ngFor="let t of transactions.slice(0, 10)" class="transaction">
            <div class="transaction-info">
              <span class="transaction-icon">{{ getTransactionIcon(t.category) }}</span>
              <div class="transaction-details">
                <span class="transaction-name">{{ t.name }}</span>
                <span class="transaction-category">{{ formatCategoryName(t.category) }}</span>
              </div>
            </div>
            <div class="transaction-amount">
              <span class="amount">{{ t.amount | currency }}</span>
              <span class="date">{{ formatDate(t.date) }}</span>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="!isLoadingTransactions && transactions.length === 0" class="empty-state">
        <p>No transactions yet. Connect your bank account or upload a CSV file to get started.</p>
      </div>
    </section>

    <!-- AI Assistant Section -->
    <section class="card ai-section">
      <div class="section-header">
        <div class="header-left">
          <div class="ai-title">
            <h2>SmartSpend AI Assistant</h2>
            <span class="ai-status">Online</span>
          </div>
        </div>
        <div class="header-right">
          <span class="groq-badge">
            <span class="groq-icon">⚡</span>
            Groq
          </span>
          <button class="expand-btn" title="Expand Chat">
            <span class="expand-icon">⤢</span>
          </button>
        </div>
      </div>
      <div class="chat-container">
        <div class="chat-messages" #chatMessages>
          <!-- Welcome message when no chat history -->
          <div *ngIf="chatHistory.length === 0" class="welcome-message">
            <div class="welcome-robot">🤖</div>
            <p>Hi! I'm your SmartSpend AI assistant powered by Groq.</p>
            <p>Ask me anything about personal finance!</p>
          </div>
          
          <!-- Chat messages -->
          <div *ngFor="let message of chatHistory" 
               class="chat-message" 
               [class.user-message]="message.type === 'user'"
               [class.ai-message]="message.type === 'ai'">
            <div class="message-avatar">
              <span *ngIf="message.type === 'user'" class="user-avatar">👤</span>
              <span *ngIf="message.type === 'ai'" class="ai-avatar">🤖</span>
            </div>
            <div class="message-content">
              <div class="message-bubble">{{ message.message }}</div>
              <div class="message-timestamp">{{ message.timestamp | date:'shortTime' }}</div>
            </div>
          </div>
          
          <!-- Show loading indicator when asking -->
          <div *ngIf="isLoadingTransactions" class="chat-message ai-message">
            <div class="message-avatar">
              <span class="ai-avatar">🤖</span>
            </div>
            <div class="message-content">
              <div class="message-bubble loading">
                <div class="typing-indicator">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="chat-input-container">
          <textarea 
            [(ngModel)]="question" 
            class="chat-input" 
            placeholder="Ask me about your spending..."
            rows="1"
            (keydown.enter)="onEnterKey($event)">
          </textarea>
          <button class="send-btn" (click)="ask()" [disabled]="!question.trim()">
            <span class="send-icon">→</span>
          </button>
        </div>
        <div class="suggested-questions">
          <button *ngFor="let suggestion of getSuggestedQuestions()" 
                  class="suggestion-chip" 
                  (click)="question = suggestion">
            {{ suggestion }}
          </button>
        </div>
      </div>
    </section>
  </main>
</div>